{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Automated OpenEMR 5.0.0 Configuration [in progress]",

  "Parameters" : {
    "EC2KeyPair" : {
      "Description" : "Amazon EC2 Key Pair",
      "Type" : "AWS::EC2::KeyPair::KeyName"
    },
    "RDSPassword" : {
      "NoEcho" : "true",
      "Description" : "The database admin account password",
      "Type" : "String",
      "MinLength" : "10",
      "MaxLength" : "41",
      "AllowedPattern" : "^[a-zA-Z0-9]*$"
    }
  },

  "Mappings" : {

  },

  "Resources" : {

    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : "10.0.0.0/16",
        "EnableDnsHostnames" : "true",
        "Tags" : [
			{"Key" : "Name", "Value" : "OpenEMR" },
			{"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} }
		]
      }
    },

    "SubnetPublic1" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : "10.0.1.0/24",
		"AvailabilityZone": { "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] },
        "Tags" : [
			{"Key" : "Name", "Value" : "Public #1" },
			{"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} }
		]
      }
    },

	"SubnetPrivate1" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : "10.0.2.0/24",
		"AvailabilityZone": { "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] },
        "Tags" : [
			{"Key" : "Name", "Value" : "Private #1" },
			{"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} }
		]
      }
    },

	"SubnetPublic2" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : "10.0.3.0/24",
		"AvailabilityZone": { "Fn::Select": [ "1", { "Fn::GetAZs": "" } ] },
        "Tags" : [
			{"Key" : "Name", "Value" : "Public #2" },
			{"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} }
		]
      }
    },

	"SubnetPrivate2" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : "10.0.4.0/24",
		"AvailabilityZone": { "Fn::Select": [ "1", { "Fn::GetAZs": "" } ] },
        "Tags" : [
			{"Key" : "Name", "Value" : "Private #2" },
			{"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} }
		]
      }
    },

    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [ {"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} } ]
      }
    },

    "AttachGateway" : {
       "Type" : "AWS::EC2::VPCGatewayAttachment",
       "Properties" : {
         "VpcId" : { "Ref" : "VPC" },
         "InternetGatewayId" : { "Ref" : "InternetGateway" }
       }
    },

    "RouteTablePublic" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : {"Ref" : "VPC"},
        "Tags" : [ {"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} } ]
      }
    },

    "RoutePublic" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "AttachGateway",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RouteTablePublic" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "InternetGateway" }
      }
    },

    "SubnetRouteTableAssociationPublic1" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "SubnetPublic1" },
        "RouteTableId" : { "Ref" : "RouteTablePublic" }
      }
    },

	"SubnetRouteTableAssociationPublic2" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "SubnetPublic2" },
        "RouteTableId" : { "Ref" : "RouteTablePublic" }
      }
    },

	"RouteTablePrivate" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : {"Ref" : "VPC"},
        "Tags" : [ {"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} } ]
      }
    },

	"EIPNATGatewayPublic1" : {
	  "Type" : "AWS::EC2::EIP",
	  "Properties" : {
		"Domain" : "vpc"
	  }
	},

	"NATGatewayPublic1" : {
	  "Type" : "AWS::EC2::NatGateway",
	  "Properties" : {
		"AllocationId" : { "Fn::GetAtt" : ["EIPNATGatewayPublic1", "AllocationId"]},
		"SubnetId" : { "Ref" : "SubnetPublic1"}
	  }
	},

	"RoutePrivate" : {
      "Type" : "AWS::EC2::Route",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RouteTablePrivate" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "NatGatewayId" : { "Ref" : "NATGatewayPublic1" }
      }
    },

	"SubnetRouteTableAssociationPrivate1" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "SubnetPrivate1" },
        "RouteTableId" : { "Ref" : "RouteTablePrivate" }
      }
    },

	"SubnetRouteTableAssociationPrivate2" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "SubnetPrivate2" },
        "RouteTableId" : { "Ref" : "RouteTablePrivate" }
      }
    },

    "SSHSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
         "GroupDescription" : "Public SSH Access",
         "Tags" :  [ { "Key" : "Name", "Value" : "Global SSH INSECURE_DEV_ONLY" } ],
         "VpcId" : {"Ref" : "VPC"}
      }
    },

    "SSHSGIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
          "GroupId": { "Ref": "SSHSecurityGroup" },
          "IpProtocol": "tcp",
          "CidrIp": "0.0.0.0/0",
          "FromPort": "22",
          "ToPort": "22"
      }
    },

  "EFSSecurityGroup" : {
    "Type" : "AWS::EC2::SecurityGroup",
    "Properties" : {
       "GroupDescription" : "EFS Access",
       "Tags" :  [ { "Key" : "Name", "Value" : "PatientDocumentAccess" } ],
       "VpcId" : {"Ref" : "VPC"}
    }
  },

  "EFSSGIngress": {
    "Type": "AWS::EC2::SecurityGroupIngress",
    "Properties": {
        "GroupId": { "Ref": "EFSSecurityGroup" },
        "IpProtocol": "tcp",
        "FromPort": "2049",
        "ToPort": "2049",
        "SourceSecurityGroupId": { "Ref": "EFSSecurityGroup" }
    }
  },

  "ElasticFileSystem" : {
    "Type" : "AWS::EFS::FileSystem",
    "Properties" : {
      "FileSystemTags" : [ { "Key" : "Name", "Value" : "PatientDocuments" } ]
    }
  },

  "EFSMountPrivate1": {
    "Type": "AWS::EFS::MountTarget",
    "Properties": {
      "FileSystemId": { "Ref": "ElasticFileSystem" },
      "SubnetId": { "Ref": "SubnetPrivate1" },
      "SecurityGroups": [ { "Ref": "EFSSecurityGroup" } ]
    }
  },

  "EFSMountPrivate2": {
    "Type": "AWS::EFS::MountTarget",
    "Properties": {
      "FileSystemId": { "Ref": "ElasticFileSystem" },
      "SubnetId": { "Ref": "SubnetPrivate2" },
      "SecurityGroups": [ { "Ref": "EFSSecurityGroup" } ]
    }
  },

  "RDSSubnetGroup": {
     "Type" : "AWS::RDS::DBSubnetGroup",
     "Properties" : {
        "DBSubnetGroupDescription" : "OpenEMR DB Subnet",
        "SubnetIds" : [ {"Ref":"SubnetPrivate1"}, {"Ref":"SubnetPrivate2"} ]
     }
  },

  "DBSecurityGroup" : {
    "Type" : "AWS::EC2::SecurityGroup",
    "Properties" : {
       "GroupDescription" : "RDS Access",
       "Tags" :  [ { "Key" : "Name", "Value" : "PatientRecordsAccess" } ],
       "VpcId" : {"Ref" : "VPC"}
    }
  },

  "DBSGIngress": {
    "Type": "AWS::EC2::SecurityGroupIngress",
    "Properties": {
        "GroupId": { "Ref": "DBSecurityGroup" },
        "IpProtocol": "tcp",
        "FromPort": "3306",
        "ToPort": "3306",
        "SourceSecurityGroupId": { "Ref": "DBSecurityGroup" }
    }
  },

  "RDSInstance" : {
     "Type" : "AWS::RDS::DBInstance",
     "Properties" : {
        "DBName" : "openemr",
        "AllocatedStorage" : "10",
        "DBInstanceClass" : "db.t2.small",
        "Engine" : "MySQL",
        "EngineVersion" : "5.6.27",
        "MasterUsername" : "openemr_db_user",
        "MasterUserPassword" : { "Ref" : "RDSPassword" },
        "PubliclyAccessible": "false",
        "DBSubnetGroupName": {"Ref": "RDSSubnetGroup"},
        "VPCSecurityGroups": [{"Ref": "DBSecurityGroup"}],
        "MultiAZ": "false",
        "Tags" : [ { "Key" : "Name", "Value" : "Patient Records" } ]
     }
  },

  "S3Bucket": {
    "Type": "AWS::S3::Bucket",
    "Properties": {
        "BucketName" : { "Fn::Join" : [ "-", [ { "Ref" : "AWS::AccountId" }, "cloudtrail", "logs" ] ] }
    }
  },
  "BucketPolicy" : {
    "Type" : "AWS::S3::BucketPolicy",
    "Properties" : {
      "Bucket" : {"Ref" : "S3Bucket"},
      "PolicyDocument" : {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "AWSCloudTrailAclCheck",
            "Effect": "Allow",
            "Principal": { "Service":"cloudtrail.amazonaws.com"},
            "Action": "s3:GetBucketAcl",
            "Resource": { "Fn::Join" : ["", ["arn:aws:s3:::", {"Ref":"S3Bucket"}]]}
          },
          {
            "Sid": "AWSCloudTrailWrite",
            "Effect": "Allow",
            "Principal": { "Service":"cloudtrail.amazonaws.com"},
            "Action": "s3:PutObject",
            "Resource": { "Fn::Join" : ["", ["arn:aws:s3:::", {"Ref":"S3Bucket"}, "/AWSLogs/", {"Ref":"AWS::AccountId"}, "/*"]]},
            "Condition": {
              "StringEquals": {
                "s3:x-amz-acl": "bucket-owner-full-control"
              }
            }
          }
        ]
      }
    }
  },
  "CloudTrail": {
    "DependsOn" : ["BucketPolicy"],
    "Type": "AWS::CloudTrail::Trail",
    "Properties": {
      "IsLogging": "true",
      "IncludeGlobalServiceEvents" : "true",
      "IsMultiRegionTrail" : "true",
      "S3BucketName": { "Ref" : "S3Bucket" }
    }
  }

},

  "Outputs" : {
    "VPC" : {
      "Value" : { "Ref": "VPC" },
      "Description" : "Newly created VPC id"
    },

    "EFS" : {
      "Value" : { "Ref": "ElasticFileSystem" },
      "Description" : "EFS id for 00-config"
    },

    "RDS": {
      "Value" : { "Fn::GetAtt" : ["RDSInstance", "Endpoint.Address"]},
      "Description" : "RDS endpoint for OpenEMR setup process"
    }
  }
}
