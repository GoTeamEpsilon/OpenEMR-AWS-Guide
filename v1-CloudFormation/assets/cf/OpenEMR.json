{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Automated OpenEMR 5.0.0 Configuration [in progress]",

  "Parameters" : {
    "EC2KeyPair" : {
      "Description" : "Amazon EC2 Key Pair",
      "Type" : "AWS::EC2::KeyPair::KeyName"
    },
    "RDSPassword" : {
      "NoEcho" : "true",
      "Description" : "The database admin account password",
      "Type" : "String",
      "MinLength" : "10",
      "MaxLength" : "41",
      "AllowedPattern" : "^[a-zA-Z0-9]*$"
    },
    "TimeZone": {
      "Type": "String",
      "Default": "America\\\\/Chicago",
      "MaxLength": "41",
      "Description" : "The timezone OpenEMR will run in (** CHECK THE GUIDE FOR SYNTAX **)"
    }
  },

  "Mappings" : {

    "RegionData" : {
      "us-east-1" : {
        "ApplicationBucket": "openemr-useast1",
        "ApplicationSource": "beanstalk/openemr-5.0.0-001.zip"
      }
    }
  },

  "Resources" : {

    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : "10.0.0.0/16",
        "EnableDnsHostnames" : "true",
        "Tags" : [
			{"Key" : "Name", "Value" : "OpenEMR" },
			{"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} }
		]
      }
    },

    "SubnetPublic1" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : "10.0.1.0/24",
		"AvailabilityZone": { "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] },
        "Tags" : [
			{"Key" : "Name", "Value" : "Public #1" },
			{"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} }
		]
      }
    },

	"SubnetPrivate1" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : "10.0.2.0/24",
		"AvailabilityZone": { "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] },
        "Tags" : [
			{"Key" : "Name", "Value" : "Private #1" },
			{"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} }
		]
      }
    },

	"SubnetPublic2" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : "10.0.3.0/24",
		"AvailabilityZone": { "Fn::Select": [ "1", { "Fn::GetAZs": "" } ] },
        "Tags" : [
			{"Key" : "Name", "Value" : "Public #2" },
			{"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} }
		]
      }
    },

	"SubnetPrivate2" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : "10.0.4.0/24",
		"AvailabilityZone": { "Fn::Select": [ "1", { "Fn::GetAZs": "" } ] },
        "Tags" : [
			{"Key" : "Name", "Value" : "Private #2" },
			{"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} }
		]
      }
    },

    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [ {"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} } ]
      }
    },

    "AttachGateway" : {
       "Type" : "AWS::EC2::VPCGatewayAttachment",
       "Properties" : {
         "VpcId" : { "Ref" : "VPC" },
         "InternetGatewayId" : { "Ref" : "InternetGateway" }
       }
    },

    "RouteTablePublic" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : {"Ref" : "VPC"},
        "Tags" : [ {"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} } ]
      }
    },

    "RoutePublic" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "AttachGateway",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RouteTablePublic" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "InternetGateway" }
      }
    },

    "SubnetRouteTableAssociationPublic1" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "SubnetPublic1" },
        "RouteTableId" : { "Ref" : "RouteTablePublic" }
      }
    },

	"SubnetRouteTableAssociationPublic2" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "SubnetPublic2" },
        "RouteTableId" : { "Ref" : "RouteTablePublic" }
      }
    },

	"RouteTablePrivate" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : {"Ref" : "VPC"},
        "Tags" : [ {"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} } ]
      }
    },

	"EIPNATGatewayPublic1" : {
	  "Type" : "AWS::EC2::EIP",
	  "Properties" : {
		"Domain" : "vpc"
	  }
	},

	"NATGatewayPublic1" : {
	  "Type" : "AWS::EC2::NatGateway",
	  "Properties" : {
		"AllocationId" : { "Fn::GetAtt" : ["EIPNATGatewayPublic1", "AllocationId"]},
		"SubnetId" : { "Ref" : "SubnetPublic1"}
	  }
	},

	"RoutePrivate" : {
      "Type" : "AWS::EC2::Route",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RouteTablePrivate" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "NatGatewayId" : { "Ref" : "NATGatewayPublic1" }
      }
    },

	"SubnetRouteTableAssociationPrivate1" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "SubnetPrivate1" },
        "RouteTableId" : { "Ref" : "RouteTablePrivate" }
      }
    },

	"SubnetRouteTableAssociationPrivate2" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "SubnetPrivate2" },
        "RouteTableId" : { "Ref" : "RouteTablePrivate" }
      }
    },

    "SSHSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
         "GroupDescription" : "Public SSH Access",
         "Tags" :  [ { "Key" : "Name", "Value" : "Global SSH INSECURE_DEV_ONLY" } ],
         "VpcId" : {"Ref" : "VPC"}
      }
    },

    "SSHSGIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
          "GroupId": { "Ref": "SSHSecurityGroup" },
          "IpProtocol": "tcp",
          "CidrIp": "0.0.0.0/0",
          "FromPort": "22",
          "ToPort": "22"
      }
    },

    "ApplicationSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
         "GroupDescription" : "Application Security Group",
         "Tags" :  [ { "Key" : "Name", "Value" : "Application" } ],
         "VpcId" : {"Ref" : "VPC"}
      }
    },

    "AppSGIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
          "GroupId": { "Ref": "ApplicationSecurityGroup" },
          "IpProtocol": "-1",
          "SourceSecurityGroupId" : { "Ref": "ApplicationSecurityGroup"}
      }
    },

  "EFSSecurityGroup" : {
    "Type" : "AWS::EC2::SecurityGroup",
    "Properties" : {
       "GroupDescription" : "EFS Access",
       "Tags" :  [ { "Key" : "Name", "Value" : "PatientDocumentAccess" } ],
       "VpcId" : {"Ref" : "VPC"}
    }
  },

  "EFSSGIngress": {
    "Type": "AWS::EC2::SecurityGroupIngress",
    "Properties": {
        "GroupId": { "Ref": "EFSSecurityGroup" },
        "IpProtocol": "-1",
        "SourceSecurityGroupId" : { "Ref": "ApplicationSecurityGroup"}
    }
  },

  "ElasticFileSystem" : {
    "Type" : "AWS::EFS::FileSystem",
    "Properties" : {
      "FileSystemTags" : [ { "Key" : "Name", "Value" : "PatientDocuments" } ]
    }
  },

  "EFSMountPrivate1": {
    "Type": "AWS::EFS::MountTarget",
    "Properties": {
      "FileSystemId": { "Ref": "ElasticFileSystem" },
      "SubnetId": { "Ref": "SubnetPrivate1" },
      "SecurityGroups": [ { "Ref": "EFSSecurityGroup" } ]
    }
  },

  "EFSMountPrivate2": {
    "Type": "AWS::EFS::MountTarget",
    "Properties": {
      "FileSystemId": { "Ref": "ElasticFileSystem" },
      "SubnetId": { "Ref": "SubnetPrivate2" },
      "SecurityGroups": [ { "Ref": "EFSSecurityGroup" } ]
    }
  },

  "RDSSubnetGroup": {
     "Type" : "AWS::RDS::DBSubnetGroup",
     "Properties" : {
        "DBSubnetGroupDescription" : "OpenEMR DB Subnet",
        "SubnetIds" : [ {"Ref":"SubnetPrivate1"}, {"Ref":"SubnetPrivate2"} ]
     }
  },

  "DBSecurityGroup" : {
    "Type" : "AWS::EC2::SecurityGroup",
    "Properties" : {
       "GroupDescription" : "RDS Access",
       "Tags" :  [ { "Key" : "Name", "Value" : "PatientRecordsAccess" } ],
       "VpcId" : {"Ref" : "VPC"}
    }
  },

  "DBSGIngress": {
    "Type": "AWS::EC2::SecurityGroupIngress",
    "Properties": {
        "GroupId": { "Ref": "DBSecurityGroup" },
        "IpProtocol": "-1",
        "SourceSecurityGroupId" : { "Ref": "ApplicationSecurityGroup"}
    }
  },

  "RDSInstance" : {
     "Type" : "AWS::RDS::DBInstance",
     "Properties" : {
        "DBName" : "openemr",
        "AllocatedStorage" : "10",
        "DBInstanceClass" : "db.t2.small",
        "Engine" : "MySQL",
        "EngineVersion" : "5.6.27",
        "MasterUsername" : "openemr_db_user",
        "MasterUserPassword" : { "Ref" : "RDSPassword" },
        "PubliclyAccessible": "false",
        "DBSubnetGroupName": {"Ref": "RDSSubnetGroup"},
        "VPCSecurityGroups": [{"Ref": "DBSecurityGroup"}],
        "MultiAZ": "false",
        "Tags" : [ { "Key" : "Name", "Value" : "Patient Records" } ]
     }
  },

  "S3Bucket": {
    "Type": "AWS::S3::Bucket",
    "DeletionPolicy": "Retain",
    "Properties": {
        "BucketName" : { "Fn::Join" : [ "-", [
          "openemr",
          { "Fn::Select" : [ "2", { "Fn::Split": ["/", {"Ref": "AWS::StackId"}]}] }
        ] ] }
    }
  },
  "BucketPolicy" : {
    "Type" : "AWS::S3::BucketPolicy",
    "Properties" : {
      "Bucket" : {"Ref" : "S3Bucket"},
      "PolicyDocument" : {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "AWSCloudTrailAclCheck",
            "Effect": "Allow",
            "Principal": { "Service":"cloudtrail.amazonaws.com"},
            "Action": "s3:GetBucketAcl",
            "Resource": { "Fn::Join" : ["", ["arn:aws:s3:::", {"Ref":"S3Bucket"}]]}
          },
          {
            "Sid": "AWSCloudTrailWrite",
            "Effect": "Allow",
            "Principal": { "Service":"cloudtrail.amazonaws.com"},
            "Action": "s3:PutObject",
            "Resource": { "Fn::Join" : ["", ["arn:aws:s3:::", {"Ref":"S3Bucket"}, "/AWSLogs/", {"Ref":"AWS::AccountId"}, "/*"]]},
            "Condition": {
              "StringEquals": {
                "s3:x-amz-acl": "bucket-owner-full-control"
              }
            }
          }
        ]
      }
    }
  },
  "CloudTrail": {
    "DependsOn" : ["BucketPolicy"],
    "Type": "AWS::CloudTrail::Trail",
    "Properties": {
      "IsLogging": "true",
      "IncludeGlobalServiceEvents" : "true",
      "IsMultiRegionTrail" : "true",
      "S3BucketName": { "Ref" : "S3Bucket" }
    }
  },

  "RedisSubnetGroup" :  {
    "Type": "AWS::ElastiCache::SubnetGroup",
    "Properties": {
        "Description": "Redis node locations",
        "SubnetIds": [
            {
                "Ref": "SubnetPrivate2"
            },
            {
                "Ref": "SubnetPrivate1"
            }
        ]
      }
    },

  "RedisSecurityGroup" : {
    "Type" : "AWS::EC2::SecurityGroup",
    "Properties" : {
       "GroupDescription" : "Redis Access",
       "Tags" :  [ { "Key" : "Name", "Value" : "OpenEMR Sessions" } ],
       "VpcId" : {"Ref" : "VPC"}
    }
  },

  "RedisSGIngress": {
    "Type": "AWS::EC2::SecurityGroupIngress",
    "Properties": {
        "GroupId": { "Ref": "RedisSecurityGroup" },
        "IpProtocol": "-1",
        "SourceSecurityGroupId" : { "Ref": "ApplicationSecurityGroup"}
    }
  },

   "RedisCluster" : {
      "Type": "AWS::ElastiCache::CacheCluster",
      "Properties": {
        "CacheNodeType"           : "cache.t2.medium",
        "VpcSecurityGroupIds": [{"Fn::GetAtt": [ "RedisSecurityGroup", "GroupId"]}],
        "CacheSubnetGroupName"    : { "Ref": "RedisSubnetGroup"},
        "Engine"                  : "redis",
        "NumCacheNodes"           : "1"
      }
    },

    "EBApplication" : {
      "Type" : "AWS::ElasticBeanstalk::Application",
      "Properties" : {
        "Description" : "OpenEMR Application Stack"
      }
    },

    "EBApplicationVersion" : {
      "Type" : "AWS::ElasticBeanstalk::ApplicationVersion",
      "Properties" : {
        "Description" : "Version 5.0.0",
        "ApplicationName" : { "Ref" : "EBApplication" },
        "SourceBundle" : {
          "S3Bucket" : { "Fn::FindInMap" : [ "RegionData", { "Ref" : "AWS::Region" }, "ApplicationBucket"]},
          "S3Key" : { "Fn::FindInMap" : [ "RegionData", { "Ref" : "AWS::Region" }, "ApplicationSource"]}
        }
      }
    },

    "EBEnvironment" : {
     "Type" : "AWS::ElasticBeanstalk::Environment",
     "Properties" : {
       "ApplicationName" : { "Ref" : "EBApplication" },
        "Description" :  "OpenEMR v5.0.0, cloud deployment 001",
        "SolutionStackName" : "64bit Amazon Linux 2017.03 v2.4.1 running PHP 7.0",
        "VersionLabel" : { "Ref" : "EBApplicationVersion" },
        "OptionSettings" : [
          {"Namespace" : "aws:autoscaling:launchconfiguration", "OptionName" : "SecurityGroups", "Value" : { "Ref" : "ApplicationSecurityGroup" }},
          {"Namespace" : "aws:autoscaling:launchconfiguration", "OptionName" : "EC2KeyName", "Value" : { "Ref" : "EC2KeyPair" }},
          {"Namespace" : "aws:elb:policies", "OptionName" : "ConnectionSettingIdleTimeout", "Value" : "3600"},
          {"Namespace" : "aws:ec2:vpc", "OptionName" : "VPCId", "Value" : { "Ref" : "VPC" }},
          {"Namespace" : "aws:ec2:vpc", "OptionName" : "Subnets", "Value" :
            { "Fn::Join" : [ ",", [ {"Ref": "SubnetPrivate1"}, {"Ref": "SubnetPrivate2"} ] ] }
          },
          {"Namespace" : "aws:ec2:vpc", "OptionName" : "ELBSubnets", "Value" :
            { "Fn::Join" : [ ",", [ {"Ref": "SubnetPublic1"}, {"Ref": "SubnetPublic2"} ] ] }
          },
          {"Namespace" : "aws:elasticbeanstalk:application:environment", "OptionName": "TIMEZONE", "Value": {"Ref" : "TimeZone"}},
          {"Namespace" : "aws:elasticbeanstalk:application:environment", "OptionName": "REDIS_IP", "Value": { "Fn::GetAtt" : ["RedisCluster", "RedisEndpoint.Address"]}},
          {"Namespace" : "aws:elasticbeanstalk:application:environment", "OptionName": "FILE_SYSTEM_ID", "Value": {"Ref" : "ElasticFileSystem"}}
       ]
     }
   }


},

  "Outputs" : {
    "RDS": {
      "Value" : { "Fn::GetAtt" : ["RDSInstance", "Endpoint.Address"]},
      "Description" : "RDS endpoint for OpenEMR setup process"
    },

    "URL" : {
      "Description" : "OpenEMR Setup",
      "Value" :  { "Fn::Join" : [ "", [ "http://", { "Fn::GetAtt" : ["EBEnvironment", "EndpointURL"] }, "/openemr"]]}
    }
  }
}
